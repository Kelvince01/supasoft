# ============================================================================
# Supasoft GitLab CI/CD Pipeline
# ============================================================================
# Description: Automated CI/CD pipeline for building, testing, and deploying
#              Supasoft Supermarket Management System
# ============================================================================

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version"
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  
  # Application variables
  APP_NAME: "supasoft-api"
  REGISTRY_URL: "registry.gitlab.com"
  IMAGE_TAG: "$CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG-$CI_COMMIT_SHORT_SHA"
  
  # Java and Maven versions
  JAVA_VERSION: "21"
  MAVEN_VERSION: "3.9.5"

# Cache configuration for faster builds
cache:
  key: "$CI_COMMIT_REF_SLUG"
  paths:
    - .m2/repository
    - target/
    - */target/

# Pipeline stages
stages:
  - validate
  - build
  - test
  - quality
  - package
  - deploy
  - notify

# ============================================================================
# Templates
# ============================================================================

.maven_template: &maven_template
  image: maven:${MAVEN_VERSION}-eclipse-temurin-${JAVA_VERSION}
  before_script:
    - echo "Maven version:"
    - mvn --version
    - echo "Java version:"
    - java -version

.docker_template: &docker_template
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - docker info
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY

# ============================================================================
# Validate Stage
# ============================================================================

validate:pom:
  <<: *maven_template
  stage: validate
  script:
    - echo "Validating POM files..."
    - mvn validate $MAVEN_CLI_OPTS
  only:
    - merge_requests
    - main
    - develop

validate:code-format:
  <<: *maven_template
  stage: validate
  script:
    - echo "Checking code formatting..."
    - mvn spotless:check $MAVEN_CLI_OPTS || echo "Code formatting issues found"
  allow_failure: true
  only:
    - merge_requests
    - main
    - develop

# ============================================================================
# Build Stage
# ============================================================================

build:compile:
  <<: *maven_template
  stage: build
  script:
    - echo "Compiling project..."
    - mvn clean compile $MAVEN_CLI_OPTS -DskipTests
  artifacts:
    paths:
      - "*/target/"
    expire_in: 1 hour
  only:
    - merge_requests
    - main
    - develop
    - tags

# ============================================================================
# Test Stage
# ============================================================================

test:unit:
  <<: *maven_template
  stage: test
  needs: ["build:compile"]
  script:
    - echo "Running unit tests..."
    - mvn test $MAVEN_CLI_OPTS -Dtest.profile=unit
  coverage: '/Total.*?([0-9]{1,3})%/'
  artifacts:
    when: always
    reports:
      junit:
        - "*/target/surefire-reports/TEST-*.xml"
    paths:
      - "*/target/surefire-reports/"
      - "*/target/site/jacoco/"
    expire_in: 7 days
  only:
    - merge_requests
    - main
    - develop

test:integration:
  <<: *maven_template
  stage: test
  needs: ["build:compile"]
  services:
    - name: mysql:8.0
      alias: mysql
    - name: redis:7-alpine
      alias: redis
  variables:
    MYSQL_ROOT_PASSWORD: "test_root_pass"
    MYSQL_DATABASE: "supasoft_test"
    MYSQL_USER: "test_user"
    MYSQL_PASSWORD: "test_pass"
    SPRING_PROFILES_ACTIVE: "test"
    DB_HOST: "mysql"
    REDIS_HOST: "redis"
  script:
    - echo "Running integration tests..."
    - mvn verify $MAVEN_CLI_OPTS -Dtest.profile=integration -DskipUnitTests=true
  artifacts:
    when: always
    reports:
      junit:
        - "*/target/failsafe-reports/TEST-*.xml"
    paths:
      - "*/target/failsafe-reports/"
    expire_in: 7 days
  only:
    - merge_requests
    - main
    - develop
  allow_failure: true

test:security:
  <<: *maven_template
  stage: test
  needs: ["build:compile"]
  script:
    - echo "Running OWASP dependency check..."
    - mvn dependency-check:check $MAVEN_CLI_OPTS || true
  artifacts:
    when: always
    paths:
      - "*/target/dependency-check-report.html"
    expire_in: 7 days
  allow_failure: true
  only:
    - schedules
    - main
    - develop

# ============================================================================
# Code Quality Stage
# ============================================================================

quality:sonarqube:
  <<: *maven_template
  stage: quality
  needs: ["test:unit"]
  script:
    - echo "Running SonarQube analysis..."
    - mvn sonar:sonar 
        $MAVEN_CLI_OPTS
        -Dsonar.projectKey=$CI_PROJECT_NAME
        -Dsonar.host.url=$SONAR_HOST_URL
        -Dsonar.login=$SONAR_TOKEN
        -Dsonar.branch.name=$CI_COMMIT_REF_NAME
  only:
    - main
    - develop
    - merge_requests
  allow_failure: true

quality:checkstyle:
  <<: *maven_template
  stage: quality
  needs: ["build:compile"]
  script:
    - echo "Running Checkstyle..."
    - mvn checkstyle:checkstyle $MAVEN_CLI_OPTS
  artifacts:
    paths:
      - "*/target/checkstyle-result.xml"
    expire_in: 7 days
  allow_failure: true
  only:
    - merge_requests
    - main
    - develop

# ============================================================================
# Package Stage
# ============================================================================

package:jars:
  <<: *maven_template
  stage: package
  needs: ["test:unit"]
  script:
    - echo "Packaging JAR files..."
    - mvn package $MAVEN_CLI_OPTS -DskipTests
  artifacts:
    paths:
      - "*/target/*.jar"
      - "!*/target/*-sources.jar"
      - "!*/target/*-javadoc.jar"
    expire_in: 30 days
  only:
    - main
    - develop
    - tags

package:docker:discovery:
  <<: *docker_template
  stage: package
  needs: ["package:jars"]
  script:
    - echo "Building Discovery Service Docker image..."
    - docker build -t $CI_REGISTRY_IMAGE/discovery:$CI_COMMIT_SHORT_SHA -f discovery/Dockerfile .
    - docker tag $CI_REGISTRY_IMAGE/discovery:$CI_COMMIT_SHORT_SHA $CI_REGISTRY_IMAGE/discovery:latest
    - docker push $CI_REGISTRY_IMAGE/discovery:$CI_COMMIT_SHORT_SHA
    - docker push $CI_REGISTRY_IMAGE/discovery:latest
  only:
    - main
    - tags

package:docker:gateway:
  <<: *docker_template
  stage: package
  needs: ["package:jars"]
  script:
    - echo "Building API Gateway Docker image..."
    - docker build -t $CI_REGISTRY_IMAGE/gateway:$CI_COMMIT_SHORT_SHA -f api-gateway/Dockerfile .
    - docker tag $CI_REGISTRY_IMAGE/gateway:$CI_COMMIT_SHORT_SHA $CI_REGISTRY_IMAGE/gateway:latest
    - docker push $CI_REGISTRY_IMAGE/gateway:$CI_COMMIT_SHORT_SHA
    - docker push $CI_REGISTRY_IMAGE/gateway:latest
  only:
    - main
    - tags

package:docker:services:
  <<: *docker_template
  stage: package
  needs: ["package:jars"]
  parallel:
    matrix:
      - SERVICE: [auth, item, pricing, stock, sales, purchase, transfer, reports, notification, integration]
  script:
    - echo "Building $SERVICE service Docker image..."
    - docker build -t $CI_REGISTRY_IMAGE/${SERVICE}-service:$CI_COMMIT_SHORT_SHA -f ${SERVICE}-service/Dockerfile .
    - docker tag $CI_REGISTRY_IMAGE/${SERVICE}-service:$CI_COMMIT_SHORT_SHA $CI_REGISTRY_IMAGE/${SERVICE}-service:latest
    - docker push $CI_REGISTRY_IMAGE/${SERVICE}-service:$CI_COMMIT_SHORT_SHA
    - docker push $CI_REGISTRY_IMAGE/${SERVICE}-service:latest
  only:
    - main
    - tags

# ============================================================================
# Deploy Stage
# ============================================================================

deploy:dev:
  <<: *docker_template
  stage: deploy
  needs: ["package:docker:gateway", "package:docker:services"]
  environment:
    name: development
    url: https://dev.supasoft.com
  script:
    - echo "Deploying to development environment..."
    - echo "Docker compose pull and up..."
    # Add your deployment script here
    # Example: ssh to dev server and run docker-compose pull && docker-compose up -d
  only:
    - develop
  when: manual

deploy:staging:
  <<: *docker_template
  stage: deploy
  needs: ["package:docker:gateway", "package:docker:services"]
  environment:
    name: staging
    url: https://staging.supasoft.com
  script:
    - echo "Deploying to staging environment..."
    # Add your staging deployment script here
  only:
    - main
  when: manual

deploy:production:
  <<: *docker_template
  stage: deploy
  needs: ["package:docker:gateway", "package:docker:services"]
  environment:
    name: production
    url: https://api.supasoft.com
  script:
    - echo "Deploying to production environment..."
    - echo "Running health checks before deployment..."
    # Add health check scripts
    - echo "Deploying with zero-downtime strategy..."
    # Add your production deployment script here
  only:
    - tags
  when: manual

# ============================================================================
# Database Migration (Production)
# ============================================================================

migrate:production:
  <<: *maven_template
  stage: deploy
  environment:
    name: production
  script:
    - echo "Running database migrations on production..."
    - mvn flyway:migrate -Dflyway.url=$PROD_DB_URL -Dflyway.user=$PROD_DB_USER -Dflyway.password=$PROD_DB_PASSWORD
  only:
    - tags
  when: manual
  allow_failure: false

# ============================================================================
# Notification Stage
# ============================================================================

notify:success:
  image: curlimages/curl:latest
  stage: notify
  script:
    - echo "Pipeline succeeded! Sending notification..."
    - |
      curl -X POST $SLACK_WEBHOOK_URL \
        -H 'Content-Type: application/json' \
        -d "{
          \"text\": \"✅ Pipeline succeeded for $CI_PROJECT_NAME\",
          \"attachments\": [{
            \"color\": \"good\",
            \"fields\": [
              {\"title\": \"Branch\", \"value\": \"$CI_COMMIT_REF_NAME\", \"short\": true},
              {\"title\": \"Commit\", \"value\": \"$CI_COMMIT_SHORT_SHA\", \"short\": true},
              {\"title\": \"Author\", \"value\": \"$GITLAB_USER_NAME\", \"short\": true},
              {\"title\": \"Pipeline\", \"value\": \"$CI_PIPELINE_URL\", \"short\": false}
            ]
          }]
        }"
  when: on_success
  only:
    - main
    - tags
  allow_failure: true

notify:failure:
  image: curlimages/curl:latest
  stage: notify
  script:
    - echo "Pipeline failed! Sending notification..."
    - |
      curl -X POST $SLACK_WEBHOOK_URL \
        -H 'Content-Type: application/json' \
        -d "{
          \"text\": \"❌ Pipeline failed for $CI_PROJECT_NAME\",
          \"attachments\": [{
            \"color\": \"danger\",
            \"fields\": [
              {\"title\": \"Branch\", \"value\": \"$CI_COMMIT_REF_NAME\", \"short\": true},
              {\"title\": \"Commit\", \"value\": \"$CI_COMMIT_SHORT_SHA\", \"short\": true},
              {\"title\": \"Author\", \"value\": \"$GITLAB_USER_NAME\", \"short\": true},
              {\"title\": \"Pipeline\", \"value\": \"$CI_PIPELINE_URL\", \"short\": false}
            ]
          }]
        }"
  when: on_failure
  only:
    - main
    - tags
  allow_failure: true

# ============================================================================
# Scheduled Jobs
# ============================================================================

backup:database:
  image: mysql:8.0
  stage: deploy
  script:
    - echo "Running scheduled database backup..."
    - ./scripts/backup-database.sh
  only:
    - schedules
  when: always

# ============================================================================
# Release Management
# ============================================================================

release:notes:
  image: alpine:latest
  stage: deploy
  before_script:
    - apk add --no-cache git
  script:
    - echo "Generating release notes..."
    - git log --pretty=format:"- %s (%an)" $(git describe --tags --abbrev=0 @^)..@ > RELEASE_NOTES.md
  artifacts:
    paths:
      - RELEASE_NOTES.md
    expire_in: 90 days
  only:
    - tags

# ============================================================================
# Manual Jobs
# ============================================================================

rollback:production:
  <<: *docker_template
  stage: deploy
  environment:
    name: production
  script:
    - echo "Rolling back production deployment..."
    - echo "Reverting to previous version..."
    # Add rollback script
  when: manual
  only:
    - main
    - tags

